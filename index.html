<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HydroPals üíß</title>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --deep: #0a1628;
    --ocean: #0d3b6e;
    --wave: #1a6fad;
    --sky: #38b6ff;
    --foam: #a8e6ff;
    --mint: #00e5c3;
    --sun: #ffe066;
    --coral: #ff6b6b;
    --white: #f0faff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--deep);
    color: var(--white);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(26,111,173,0.3) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(0,229,195,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 60% 80%, rgba(56,182,255,0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .bubbles { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .bubble {
    position: absolute; border-radius: 50%;
    background: rgba(56,182,255,0.08);
    border: 1px solid rgba(56,182,255,0.15);
    animation: floatUp linear infinite; bottom: -100px;
  }
  @keyframes floatUp {
    0% { transform: translateY(0) scale(1); opacity: 0; }
    10% { opacity: 1; } 90% { opacity: 0.5; }
    100% { transform: translateY(-110vh) scale(1.2); opacity: 0; }
  }

  /* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
  #splash {
    position: fixed; inset: 0; z-index: 500;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: var(--deep);
    transition: opacity 0.7s ease;
    cursor: pointer;
    user-select: none;
  }

  #splash.hidden { opacity: 0; pointer-events: none; }

  .splash-logo {
    font-family: 'Righteous', cursive;
    font-size: 3.2rem;
    background: linear-gradient(135deg, var(--sky), var(--mint));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    letter-spacing: 3px;
    animation: splashPop 0.8s cubic-bezier(0.175,0.885,0.32,1.275) both;
  }

  @keyframes splashPop {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .splash-drop {
    font-size: 5rem;
    margin-bottom: 20px;
    animation: dropBounce 1s cubic-bezier(0.175,0.885,0.32,1.275) 0.1s both;
  }

  @keyframes dropBounce {
    0% { transform: translateY(-60px) scale(0.5); opacity: 0; }
    70% { transform: translateY(8px) scale(1.1); }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }

  .splash-tagline {
    font-size: 1rem;
    color: var(--foam);
    opacity: 0.75;
    margin-top: 10px;
    text-align: center;
    max-width: 260px;
    line-height: 1.6;
    animation: fadeUp 0.7s ease 0.5s both;
  }

  .splash-tap {
    margin-top: 56px;
    font-size: 0.82rem;
    color: var(--sky);
    opacity: 0.6;
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: 700;
    animation: tapPulse 1.6s ease-in-out 1s infinite;
  }

  @keyframes tapPulse {
    0%, 100% { opacity: 0.4; transform: translateY(0); }
    50% { opacity: 0.9; transform: translateY(-4px); }
  }

  @keyframes fadeUp {
    0% { opacity: 0; transform: translateY(16px); }
    100% { opacity: 0.75; transform: translateY(0); }
  }

  /* wave decoration on splash */
  .splash-wave {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 140px;
    background: linear-gradient(to top, rgba(26,111,173,0.25), transparent);
    border-radius: 80% 80% 0 0 / 40px 40px 0 0;
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading-screen {
    position: fixed; inset: 0; background: var(--deep);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 200; gap: 20px; transition: opacity 0.4s;
  }
  .loading-logo { font-family: 'Righteous', cursive; font-size: 2.5rem; background: linear-gradient(135deg, var(--sky), var(--mint)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .loading-dots { display: flex; gap: 8px; }
  .loading-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--sky); animation: dotPulse 1.2s ease-in-out infinite; }
  .loading-dot:nth-child(2) { animation-delay: 0.2s; background: var(--mint); }
  .loading-dot:nth-child(3) { animation-delay: 0.4s; background: var(--foam); }
  @keyframes dotPulse { 0%,100%{transform:scale(0.6);opacity:0.4} 50%{transform:scale(1);opacity:1} }

  .container { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 20px 16px 80px; }

  header { text-align: center; padding: 30px 0 20px; }
  .logo { font-family: 'Righteous', cursive; font-size: 2.8rem; background: linear-gradient(135deg, var(--sky), var(--mint)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 2px; }
  .tagline { color: var(--foam); font-size: 0.85rem; opacity: 0.7; margin-top: 4px; letter-spacing: 1px; text-transform: uppercase; }

  .screen { display: none; }
  .screen.active { display: block; }

  .setup-card {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(56,182,255,0.2);
    border-radius: 24px; padding: 32px 24px; text-align: center;
    backdrop-filter: blur(10px); margin-top: 20px;
  }
  .setup-card h2 { font-family: 'Righteous', cursive; font-size: 1.6rem; color: var(--sky); margin-bottom: 8px; }
  .setup-card p { color: var(--foam); opacity: 0.8; margin-bottom: 24px; }

  input[type="text"] {
    width: 100%; background: rgba(255,255,255,0.08); border: 2px solid rgba(56,182,255,0.3);
    border-radius: 14px; padding: 14px 18px; font-size: 1.1rem;
    font-family: 'Nunito', sans-serif; color: var(--white); outline: none;
    transition: border-color 0.3s; margin-bottom: 16px;
  }
  input[type="time"] {
    background: rgba(255,255,255,0.08); border: 2px solid rgba(56,182,255,0.3);
    border-radius: 12px; padding: 10px 14px; font-size: 0.95rem;
    font-family: 'Nunito', sans-serif; color: var(--white); outline: none;
    transition: border-color 0.3s; flex: 1;
  }
  input[type="text"]::placeholder { color: rgba(168,230,255,0.4); }
  input[type="text"]:focus, input[type="time"]:focus { border-color: var(--sky); }
  input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.5; }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border-radius: 50px; border: none; font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 800; cursor: pointer; transition: all 0.2s; }
  .btn:active { transform: scale(0.96); }
  .btn-primary { background: linear-gradient(135deg, var(--sky), var(--mint)); color: var(--deep); width: 100%; font-size: 1.1rem; }
  .btn-primary:hover { box-shadow: 0 8px 30px rgba(56,182,255,0.4); transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .btn-outline { background: transparent; border: 2px solid rgba(56,182,255,0.4); color: var(--sky); font-size: 0.9rem; padding: 10px 20px; }
  .btn-outline:hover { border-color: var(--sky); background: rgba(56,182,255,0.1); }

  .goal-picker { display: flex; gap: 8px; justify-content: center; margin-bottom: 12px; flex-wrap: wrap; }
  .goal-opt { width: 44px; height: 44px; border-radius: 50%; border: 2px solid rgba(56,182,255,0.3); background: rgba(255,255,255,0.05); color: var(--foam); font-family: 'Nunito', sans-serif; font-size: 0.95rem; font-weight: 800; cursor: pointer; transition: all 0.2s; }
  .goal-opt:hover { border-color: var(--sky); color: var(--sky); }
  .goal-opt.active { background: linear-gradient(135deg, var(--sky), var(--mint)); border-color: transparent; color: var(--deep); box-shadow: 0 4px 14px rgba(56,182,255,0.35); }

  .progress-ring-wrap { position: relative; width: 180px; height: 180px; display: inline-flex; align-items: center; justify-content: center; }
  .progress-ring-svg { position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
  .progress-ring-track { fill: none; stroke: rgba(56,182,255,0.12); stroke-width: 6; }
  .progress-ring-fill { fill: none; stroke: url(#ringGrad); stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
  .progress-ring-fill.goal-done { stroke: url(#ringGradDone); }

  .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
  .month-day { aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 700; color: rgba(255,255,255,0.25); background: rgba(255,255,255,0.04); border: 1px solid rgba(56,182,255,0.08); transition: all 0.3s; }
  .month-day.filled { background: linear-gradient(135deg, var(--wave), var(--sky)); color: white; border-color: transparent; box-shadow: 0 2px 8px rgba(56,182,255,0.25); }
  .month-day.today { border-color: var(--sky); color: var(--sky); }
  .month-day.today.filled { background: linear-gradient(135deg, var(--mint), #38b6ff); border-color: transparent; color: var(--deep); box-shadow: 0 2px 12px rgba(0,229,195,0.4); }
  .month-day.future { opacity: 0.3; }
  .month-day-header { font-size: 0.55rem; font-weight: 800; color: rgba(168,230,255,0.4); text-align: center; padding-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

  .user-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .user-greeting { font-size: 0.9rem; color: var(--foam); opacity: 0.7; }
  .user-name { font-size: 1.2rem; font-weight: 800; color: var(--white); }
  .points-badge { background: linear-gradient(135deg, var(--sun), #ffb347); color: var(--deep); border-radius: 50px; padding: 6px 16px; font-weight: 800; font-size: 0.95rem; display: flex; align-items: center; gap: 4px; }

  .drink-section { text-align: center; margin: 10px 0 24px; }
  .drink-btn { width: 180px; height: 180px; border-radius: 50%; border: none; background: linear-gradient(145deg, var(--wave), var(--sky)); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 0 0 rgba(56,182,255,0.4), 0 20px 60px rgba(26,111,173,0.5); position: relative; overflow: hidden; }
  .drink-btn::before { content: ''; position: absolute; bottom: -20px; left: -20px; right: -20px; height: 60px; background: rgba(255,255,255,0.15); border-radius: 50%; animation: waveAnim 2s ease-in-out infinite; }
  @keyframes waveAnim { 0%,100%{transform:translateY(0) scaleX(1)}50%{transform:translateY(-8px) scaleX(1.05)} }
  .drink-btn:hover { transform: scale(1.05); box-shadow: 0 0 0 16px rgba(56,182,255,0.12), 0 20px 60px rgba(26,111,173,0.6); }
  .drink-btn:active { transform: scale(0.95); }
  .drink-btn.goal-met { background: linear-gradient(145deg, #1a7a5e, var(--mint)); }
  .drink-btn-icon { font-size: 3.5rem; line-height: 1; }
  .drink-btn-label { font-family: 'Righteous', cursive; font-size: 0.85rem; letter-spacing: 1px; margin-top: 6px; color: rgba(255,255,255,0.9); }
  .drink-status { margin-top: 14px; font-size: 0.95rem; color: var(--foam); opacity: 0.7; min-height: 24px; }
  .goal-hint { margin-top: 6px; font-size: 0.8rem; color: var(--foam); opacity: 0.5; }

  .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(56,182,255,0.15); border-radius: 20px; padding: 20px; margin-bottom: 16px; backdrop-filter: blur(10px); }
  .card-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--sky); margin-bottom: 14px; font-weight: 700; }

  .week-chart { display: flex; align-items: flex-end; gap: 8px; height: 80px; justify-content: space-between; }
  .day-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; height: 100%; justify-content: flex-end; }
  .day-bar { width: 100%; border-radius: 6px 6px 0 0; background: rgba(56,182,255,0.15); min-height: 4px; transition: height 0.5s ease; }
  .day-bar.has-data { background: linear-gradient(to top, var(--wave), var(--sky)); box-shadow: 0 0 10px rgba(56,182,255,0.3); }
  .day-bar.today-bar { background: linear-gradient(to top, var(--mint), #7fffea); }
  .day-label { font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px; }
  .day-label.today-label { color: var(--mint); }

  .friends-list { display: flex; flex-direction: column; gap: 10px; }
  .friend-row { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.04); border-radius: 14px; padding: 12px 14px; border: 1px solid rgba(56,182,255,0.1); }
  .friend-avatar { width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, var(--ocean), var(--wave)); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: 2px solid rgba(56,182,255,0.3); flex-shrink: 0; }
  .friend-name { font-weight: 700; font-size: 0.95rem; flex: 1; }
  .friend-pts { font-size: 0.8rem; color: var(--sun); font-weight: 700; }
  .empty-friends { text-align: center; padding: 20px; color: var(--foam); opacity: 0.5; font-size: 0.9rem; }

  .invite-row { display: flex; gap: 8px; margin-top: 12px; }
  .invite-link-box { flex: 1; background: rgba(255,255,255,0.06); border: 1px solid rgba(56,182,255,0.2); border-radius: 12px; padding: 10px 14px; font-size: 0.78rem; color: var(--foam); word-break: break-all; font-family: monospace; user-select: all; }
  .btn-copy { background: rgba(56,182,255,0.15); border: 1px solid rgba(56,182,255,0.3); border-radius: 12px; color: var(--sky); font-size: 0.85rem; font-weight: 700; padding: 10px 14px; cursor: pointer; font-family: 'Nunito', sans-serif; transition: all 0.2s; white-space: nowrap; }
  .btn-copy:hover { background: rgba(56,182,255,0.25); }

  .goal-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .goal-label { font-size: 0.85rem; color: var(--foam); opacity: 0.8; }
  .goal-value { font-size: 1.1rem; font-weight: 800; color: var(--sky); }

  .notif-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .toggle { position: relative; width: 48px; height: 26px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; inset: 0; background: rgba(255,255,255,0.1); border-radius: 50px; cursor: pointer; transition: 0.3s; border: 1px solid rgba(56,182,255,0.2); }
  .toggle-slider::before { content: ''; position: absolute; width: 20px; height: 20px; left: 2px; top: 2px; background: white; border-radius: 50%; transition: 0.3s; }
  .toggle input:checked + .toggle-slider { background: linear-gradient(135deg, var(--sky), var(--mint)); border-color: transparent; }
  .toggle input:checked + .toggle-slider::before { transform: translateX(22px); }
  .time-picker-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; }

  .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,22,40,0.95); border-top: 1px solid rgba(56,182,255,0.15); display: flex; justify-content: space-around; padding: 10px 0 16px; z-index: 50; backdrop-filter: blur(16px); }
  .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 3px; background: none; border: none; cursor: pointer; color: rgba(168,230,255,0.4); transition: color 0.2s; font-family: 'Nunito', sans-serif; padding: 4px 16px; }
  .nav-btn.active { color: var(--sky); }
  .nav-btn-icon { font-size: 1.4rem; }
  .nav-btn-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }

  .affirmation-overlay { position: fixed; inset: 0; background: rgba(10,22,40,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); }
  .affirmation-overlay.show { opacity: 1; pointer-events: all; }
  .affirmation-card { background: linear-gradient(145deg, var(--ocean), #0a2440); border: 1px solid rgba(56,182,255,0.4); border-radius: 28px; padding: 40px 28px; text-align: center; max-width: 340px; width: 100%; transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275); box-shadow: 0 30px 80px rgba(0,0,0,0.5); }
  .affirmation-overlay.show .affirmation-card { transform: scale(1); }
  .affirmation-emoji { font-size: 4rem; margin-bottom: 16px; display: block; animation: bounce 0.6s ease 0.3s both; }
  @keyframes bounce { 0%{transform:scale(0)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }
  .affirmation-points { display: inline-block; background: linear-gradient(135deg, var(--sun), #ffb347); color: var(--deep); border-radius: 50px; padding: 4px 16px; font-weight: 800; font-size: 1rem; margin-bottom: 16px; }
  .affirmation-text { font-size: 1.3rem; font-weight: 800; line-height: 1.4; color: var(--white); margin-bottom: 8px; }
  .affirmation-sub { font-size: 0.9rem; color: var(--foam); opacity: 0.7; margin-bottom: 28px; }

  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--mint); display: inline-block; margin-right: 4px; animation: syncP 2s ease-in-out infinite; }
  @keyframes syncP { 0%,100%{opacity:0.3}50%{opacity:1} }
  .live-pill { display: inline-flex; align-items: center; gap: 4px; background: rgba(0,229,195,0.1); border: 1px solid rgba(0,229,195,0.3); border-radius: 50px; padding: 3px 10px; font-size: 0.68rem; font-weight: 700; color: var(--mint); letter-spacing: 0.5px; }

  #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, var(--wave), var(--sky)); color: white; padding: 12px 22px; border-radius: 50px; font-weight: 700; font-size: 0.9rem; z-index: 300; white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.3); transition: opacity 0.4s; opacity: 0; pointer-events: none; }
  #confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 200; }

  .join-info { background: rgba(56,182,255,0.1); border: 1px solid rgba(56,182,255,0.2); border-radius: 14px; padding: 14px; text-align: center; margin-bottom: 16px; }
  .join-inviter { font-size: 1.1rem; font-weight: 800; color: var(--sky); }
  .section { margin-bottom: 20px; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ -->
<div id="splash" onclick="dismissSplash()">
  <div class="splash-drop">üíß</div>
  <div class="splash-logo">HydroPals</div>
  <div class="splash-tagline">Welcome to HydroPals. The goal is to stay hydrated with your crew.</div>
  <div class="splash-tap">Tap to continue</div>
  <div class="splash-wave"></div>
</div>

<!-- ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ -->
<div class="loading-screen" id="loading-screen" style="display:none">
  <div class="loading-logo">üíß HydroPals</div>
  <div class="loading-dots">
    <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
  </div>
  <div style="font-size:0.85rem;color:var(--foam);opacity:0.6">Connecting...</div>
</div>

<div class="bubbles" id="bubbles"></div>
<canvas id="confetti-canvas"></canvas>
<div id="toast"></div>

<div class="container">
  <header>
    <div class="logo">üíß HydroPals</div>
    <div class="tagline">Drink together. Stay legendary.</div>
  </header>

  <!-- SETUP -->
  <div class="screen" id="screen-setup">
    <div class="setup-card">
      <h2>Welcome! üëã</h2>
      <p>What should we call you?</p>
      <input type="text" id="setup-name" placeholder="Your name..." maxlength="24"/>
      <p style="margin-bottom:10px;margin-top:-8px">Daily water goal:</p>
      <div class="goal-picker" id="setup-goal-picker">
        <button class="goal-opt" data-val="4" onclick="selectGoal(this)">4</button>
        <button class="goal-opt active" data-val="6" onclick="selectGoal(this)">6</button>
        <button class="goal-opt" data-val="8" onclick="selectGoal(this)">8</button>
        <button class="goal-opt" data-val="10" onclick="selectGoal(this)">10</button>
        <button class="goal-opt" data-val="12" onclick="selectGoal(this)">12</button>
      </div>
      <div style="font-size:0.78rem;color:var(--foam);opacity:0.6;margin-bottom:20px">glasses per day</div>
      <button class="btn btn-primary" id="setup-btn" onclick="setupUser()">üíß Start Hydrating</button>
    </div>
  </div>

  <!-- JOIN -->
  <div class="screen" id="screen-join">
    <div class="setup-card">
      <span style="font-size:3rem">ü§ù</span>
      <h2 style="margin-top:12px">You're invited!</h2>
      <div class="join-info">
        <div id="join-inviter-name" class="join-inviter"></div>
        <div style="font-size:0.85rem;color:var(--foam);opacity:0.7;margin-top:4px">wants you to join their hydration crew</div>
      </div>
      <p style="margin-bottom:20px">Enter your name to join!</p>
      <input type="text" id="join-name" placeholder="Your name..." maxlength="24"/>
      <p style="margin-bottom:10px;margin-top:-8px">Daily water goal:</p>
      <div class="goal-picker" id="join-goal-picker">
        <button class="goal-opt" data-val="4" onclick="selectGoal(this)">4</button>
        <button class="goal-opt active" data-val="6" onclick="selectGoal(this)">6</button>
        <button class="goal-opt" data-val="8" onclick="selectGoal(this)">8</button>
        <button class="goal-opt" data-val="10" onclick="selectGoal(this)">10</button>
        <button class="goal-opt" data-val="12" onclick="selectGoal(this)">12</button>
      </div>
      <div style="font-size:0.78rem;color:var(--foam);opacity:0.6;margin-bottom:20px">glasses per day</div>
      <button class="btn btn-primary" id="join-btn" onclick="joinUser()">üíß Join the Crew</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="screen" id="screen-main">

    <!-- HOME -->
    <div id="tab-home" class="tab-content">
      <div class="user-bar">
        <div>
          <div class="user-greeting">Hey there,</div>
          <div class="user-name" id="display-name">‚Äì</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="points-badge">‚≠ê <span id="display-points">0</span> pts</div>
          <div class="live-pill"><span class="sync-dot"></span>LIVE SYNC</div>
        </div>
      </div>

      <div class="card section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div class="card-title" style="margin-bottom:0">üî• This Month</div>
          <div style="font-size:0.82rem;color:var(--foam);opacity:0.65" id="streak-label"></div>
        </div>
        <div class="month-grid" id="month-grid"></div>
      </div>

      <div class="drink-section">
        <div class="progress-ring-wrap">
          <svg class="progress-ring-svg" width="180" height="180" viewBox="0 0 180 180">
            <defs>
              <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#38b6ff"/>
                <stop offset="100%" style="stop-color:#00e5c3"/>
              </linearGradient>
              <linearGradient id="ringGradDone" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00e5c3"/>
                <stop offset="100%" style="stop-color:#ffe066"/>
              </linearGradient>
            </defs>
            <circle class="progress-ring-track" cx="90" cy="90" r="84"/>
            <circle class="progress-ring-fill" id="progress-ring-fill" cx="90" cy="90" r="84"
              stroke-dasharray="527.8" stroke-dashoffset="527.8"/>
          </svg>
          <button class="drink-btn" id="drink-btn" onclick="logDrink()">
            <span class="drink-btn-icon" id="drink-btn-icon">üíß</span>
            <span class="drink-btn-label" id="drink-btn-label">LOG DRINK</span>
          </button>
        </div>
        <div class="drink-status" id="drink-status"></div>
        <div class="goal-hint" id="goal-hint"></div>
      </div>
    </div>

    <!-- STATS -->
    <div id="tab-stats" class="tab-content" style="display:none">
      <div class="card section">
        <div class="card-title">üìä This Week</div>
        <div class="week-chart" id="week-chart"></div>
      </div>
      <div class="card section">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <div>
            <div style="font-size:0.75rem;color:var(--sky);text-transform:uppercase;letter-spacing:1px;font-weight:700">Total Points</div>
            <div style="font-size:2rem;font-weight:800;color:var(--sun)" id="stat-total-pts">0</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.75rem;color:var(--sky);text-transform:uppercase;letter-spacing:1px;font-weight:700">Total Drinks</div>
            <div style="font-size:2rem;font-weight:800;color:var(--mint)" id="stat-total-drinks">0</div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid rgba(56,182,255,0.1)">
          <div>
            <div style="font-size:0.75rem;color:var(--sky);text-transform:uppercase;letter-spacing:1px;font-weight:700">Best Streak</div>
            <div style="font-size:1.5rem;font-weight:800;color:var(--coral)" id="stat-best-streak">0 days</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.75rem;color:var(--sky);text-transform:uppercase;letter-spacing:1px;font-weight:700">Current Streak</div>
            <div style="font-size:1.5rem;font-weight:800;color:var(--foam)" id="stat-cur-streak">0 days</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FRIENDS -->
    <div id="tab-friends" class="tab-content" style="display:none">
      <div class="card section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <div class="card-title" style="margin-bottom:0">üèÜ Crew Leaderboard</div>
          <div class="live-pill"><span class="sync-dot"></span>LIVE</div>
        </div>
        <div class="friends-list" id="friends-list">
          <div class="empty-friends">Loading crew...</div>
        </div>
      </div>
      <div class="card section">
        <div class="card-title">üì® Invite a Friend</div>
        <p style="font-size:0.85rem;color:var(--foam);opacity:0.7;margin-bottom:12px">Share your link and they appear in your crew the moment they join!</p>
        <div class="invite-row">
          <div class="invite-link-box" id="invite-link-display">Generating...</div>
          <button class="btn-copy" id="copy-btn" onclick="copyInviteLink()">Copy</button>
        </div>
        <button class="btn btn-outline" style="width:100%;margin-top:10px" onclick="shareInvite()">üì§ Share</button>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="tab-content" style="display:none">
      <div class="card section">
        <div class="card-title">üéØ Daily Goal</div>
        <div class="goal-row">
          <div class="goal-label">Target glasses per day</div>
          <div class="goal-value" id="settings-goal-val">6</div>
        </div>
        <div class="goal-picker" id="settings-goal-picker" style="justify-content:flex-start;margin-top:12px">
          <button class="goal-opt" data-val="4" onclick="selectGoal(this)">4</button>
          <button class="goal-opt" data-val="6" onclick="selectGoal(this)">6</button>
          <button class="goal-opt" data-val="8" onclick="selectGoal(this)">8</button>
          <button class="goal-opt" data-val="10" onclick="selectGoal(this)">10</button>
          <button class="goal-opt" data-val="12" onclick="selectGoal(this)">12</button>
        </div>
        <div style="font-size:0.8rem;color:var(--foam);opacity:0.6;margin-top:8px">Streak counts when you hit your daily goal</div>
      </div>

      <div class="card section">
        <div class="card-title">üîî Reminders</div>
        <div class="notif-row">
          <div>
            <div style="font-weight:700;font-size:0.95rem">Daily reminders</div>
            <div style="font-size:0.8rem;color:var(--foam);opacity:0.65;margin-top:2px">Get nudged to drink water</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="notif-toggle" onchange="toggleNotifications(this)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div id="notif-time-section" style="display:none">
          <div style="font-size:0.82rem;color:var(--foam);opacity:0.7;margin-bottom:8px">Remind me at:</div>
          <div class="time-picker-row">
            <input type="time" id="notif-time-1" value="09:00" onchange="saveNotifTimes()">
            <input type="time" id="notif-time-2" value="14:00" onchange="saveNotifTimes()">
            <input type="time" id="notif-time-3" value="19:00" onchange="saveNotifTimes()">
          </div>
          <div style="font-size:0.75rem;color:var(--foam);opacity:0.5;margin-top:8px">Morning ¬∑ Afternoon ¬∑ Evening</div>
        </div>
        <div id="notif-status" style="font-size:0.8rem;margin-top:10px;color:var(--mint);display:none"></div>
        <div style="font-size:0.75rem;color:var(--foam);opacity:0.4;margin-top:10px;line-height:1.5">
          Requires browser to be open. On iPhone: Safari ‚Üí Share ‚Üí Add to Home Screen for app-like alerts.
        </div>
      </div>

      <div class="card section">
        <div class="card-title">üë§ Profile</div>
        <div style="font-size:0.9rem;color:var(--foam);opacity:0.7">Logged in as</div>
        <div style="font-size:1.2rem;font-weight:800;margin-top:2px" id="settings-name-display"></div>
        <div style="font-size:0.72rem;color:var(--foam);opacity:0.35;margin-top:4px" id="settings-userid"></div>
      </div>
    </div>

  </div>
</div>

<nav class="nav" id="main-nav" style="display:none">
  <button class="nav-btn active" onclick="showTab('home',this)">
    <span class="nav-btn-icon">üíß</span><span class="nav-btn-label">Home</span>
  </button>
  <button class="nav-btn" onclick="showTab('stats',this)">
    <span class="nav-btn-icon">üìä</span><span class="nav-btn-label">Stats</span>
  </button>
  <button class="nav-btn" onclick="showTab('friends',this)">
    <span class="nav-btn-icon">üë•</span><span class="nav-btn-label">Crew</span>
  </button>
  <button class="nav-btn" onclick="showTab('settings',this)">
    <span class="nav-btn-icon">‚öôÔ∏è</span><span class="nav-btn-label">Goals</span>
  </button>
</nav>

<div class="affirmation-overlay" id="affirmation-overlay" onclick="closeAffirmation()">
  <div class="affirmation-card" onclick="event.stopPropagation()">
    <span class="affirmation-emoji" id="aff-emoji">üíß</span>
    <div class="affirmation-points" id="aff-points">+1 point!</div>
    <div class="affirmation-text" id="aff-text">Stay hydrated!</div>
    <div class="affirmation-sub" id="aff-sub">Keep it up!</div>
    <button class="btn btn-primary" onclick="closeAffirmation()" style="max-width:200px">Awesome! üéâ</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dismissSplash() {
  const splash = document.getElementById('splash');
  splash.classList.add('hidden');
  setTimeout(() => { splash.style.display = 'none'; bootApp(); }, 700);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL = 'https://qvjatwzmnikcqobtrxfk.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2amF0d3ptbmlrY3FvYnRyeGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzA2MjAsImV4cCI6MjA4NzEwNjYyMH0.E1hdQ3mGzJiPjuG8cZaf8jPmT2nZ0wPKWsiGcFqg-T8';
const SB_H = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function dbGet(id) {
  const r = await fetch(`${SB_URL}/rest/v1/users?id=eq.${id}&select=*`, { headers: SB_H });
  const d = await r.json(); return d[0] || null;
}
async function dbSave(row) {
  row.updated_at = new Date().toISOString();
  const r = await fetch(`${SB_URL}/rest/v1/users`, {
    method: 'POST',
    headers: { ...SB_H, 'Prefer': 'resolution=merge-duplicates,return=representation' },
    body: JSON.stringify(row)
  });
  if (!r.ok) throw new Error(await r.text());
}
async function dbGetMany(ids) {
  if (!ids || !ids.length) return [];
  const q = ids.map(i => `"${i}"`).join(',');
  const r = await fetch(`${SB_URL}/rest/v1/users?id=in.(${q})&select=id,name,points,streak,daily_goal,drinks`, { headers: SB_H });
  return await r.json();
}
async function dbPatch(id, patch) {
  patch.updated_at = new Date().toISOString();
  await fetch(`${SB_URL}/rest/v1/users?id=eq.${id}`, {
    method: 'PATCH',
    headers: { ...SB_H, 'Prefer': 'return=minimal' },
    body: JSON.stringify(patch)
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AFFIRMATIONS (100)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AFF = [
  {e:'üíß',t:"You are absolutely glowing right now!",s:"Your body is literally thanking you."},
  {e:'üåä',t:"Slay AND stay hydrated!",s:"The two are not mutually exclusive."},
  {e:'‚ú®',t:"That sip just upgraded your skin!",s:"Dewy era, activated."},
  {e:'üå∏',t:"Soft life includes drinking water!",s:"You get it. You really get it."},
  {e:'üíÖ',t:"Hydrated and unbothered.",s:"The ultimate combo."},
  {e:'ü´ß',t:"Bubbling with greatness!",s:"One sip at a time."},
  {e:'üéÄ',t:"Cute, hydrated, thriving!",s:"That is your whole vibe right now."},
  {e:'üå∫',t:"You are literally blooming!",s:"Keep watering yourself."},
  {e:'üíï',t:"Self care unlocked!",s:"Drinking water is the main character move."},
  {e:'ü¶ã',t:"Transformation incoming!",s:"Water is doing the heavy lifting."},
  {e:'üåà',t:"Pure magic in a glass!",s:"And you drank it. Iconic."},
  {e:'üçì',t:"Fresh, juicy, and hydrated!",s:"Just like you."},
  {e:'üí´',t:"Your cells are literally celebrating!",s:"Pop pop pop."},
  {e:'üåª',t:"Sunflower energy activated!",s:"Tall, bright, and well watered."},
  {e:'üéµ',t:"Sip sip hooray!",s:"Today is your day."},
  {e:'ü©∑',t:"That was so main character of you!",s:"Hydration is always the plot."},
  {e:'ü´∂',t:"Your future self just sent gratitude your way!",s:"They know what you did."},
  {e:'üí¶',t:"Absolutely drenched in discipline!",s:"We love to see it."},
  {e:'üåô',t:"Glowing from the inside out!",s:"Water is your best kept secret."},
  {e:'‚≠ê',t:"A star who hydrates!",s:"Name a more iconic combo."},
  {e:'üéâ',t:"Pop the confetti!",s:"You just did something great for yourself."},
  {e:'üçã',t:"Fresh and unstoppable!",s:"That sip was the move."},
  {e:'üåø',t:"Rooted, grounded, and hydrated!",s:"Nothing can shake you."},
  {e:'ü¶©',t:"Graceful and well watered!",s:"Gliding through your goals."},
  {e:'üíé',t:"Rare and hydrated!",s:"A true gem."},
  {e:'üå∑',t:"Powerful and in full bloom!",s:"That sip was everything."},
  {e:'ü´ô',t:"Jar full of good choices!",s:"You keep adding to it."},
  {e:'üçí',t:"Cherry on top? You drank water!",s:"Perfect."},
  {e:'ü¶¢',t:"Serene and hydrated!",s:"Gliding through your goals effortlessly."},
  {e:'üé™',t:"The main attraction is YOUR hydration!",s:"Everyone applauds."},
  {e:'üåä',t:"Fluid, free, and thriving!",s:"The ocean recognises you."},
  {e:'ü©µ',t:"Cool, calm, and completely hydrated!",s:"Unshakeable."},
  {e:'üé∂',t:"Your body is singing right now!",s:"Water is the melody."},
  {e:'ü™∑',t:"Rising beautifully after every sip!",s:"Lotus coded."},
  {e:'üçß',t:"You earned a sweet moment!",s:"And you spent it on water. Wise."},
  {e:'üå¨Ô∏è',t:"Fresh energy only!",s:"You are the vibe."},
  {e:'ü©∞',t:"Light on your feet and full of water!",s:"That is the secret."},
  {e:'ü´ê',t:"Full of goodness and hydration!",s:"Deep and nourished."},
  {e:'üéÄ',t:"A bow on top of a great decision!",s:"That was a cute move."},
  {e:'üíê',t:"You are the bouquet!",s:"Every sip adds a new flower."},
  {e:'ü™∏',t:"Vibrant, colorful, and hydrated!",s:"Coral reef energy."},
  {e:'üßÅ',t:"Sweet but make it healthy!",s:"Water is the frosting on your day."},
  {e:'üå∏',t:"A beautiful moment made count!",s:"You did it with that sip."},
  {e:'üíñ',t:"Heart full, body hydrated!",s:"Balance achieved."},
  {e:'üé®',t:"Painting the most gorgeous version of yourself!",s:"Water is the brush."},
  {e:'ü´ß',t:"Effervescent and electric!",s:"You are literally sparkling."},
  {e:'üåÖ',t:"Golden hour energy all day!",s:"Hydration makes everything glow."},
  {e:'üçë',t:"Peachy and perfect!",s:"That sip sealed it."},
  {e:'ü¶Ñ',t:"Mythically hydrated!",s:"Not everyone can say that. You can."},
  {e:'üíå',t:"Your kidneys just sent a thank you note!",s:"They are so grateful."},
  {e:'üåü',t:"Five stars, no notes!",s:"Your hydration game is immaculate."},
  {e:'üéØ',t:"Nailed it!",s:"Water goal in progress and looking amazing."},
  {e:'ü™Ñ',t:"Manifesting with water!",s:"The universe noticed that sip."},
  {e:'üå¥',t:"Vacation energy, every day!",s:"Hydrated and relaxed."},
  {e:'üçµ',t:"Cozy and hydrated!",s:"The softest combination."},
  {e:'ü©∑',t:"That was so kind to your body!",s:"It noticed every drop."},
  {e:'ü¶ã',t:"One sip closer to your best self!",s:"Wings incoming."},
  {e:'üåä',t:"Tides are turning in your favor!",s:"All because you drank water."},
  {e:'üå∫',t:"Tropical, vibrant, and hydrated!",s:"Full hibiscus energy."},
  {e:'üéµ',t:"You are the song and water is the beat!",s:"Keep the rhythm going."},
  {e:'üåô',t:"Moonlit and magical!",s:"You hydrate at every hour. Respect."},
  {e:'üçì',t:"Berry good decision!",s:"Honestly one of your best today."},
  {e:'‚ú®',t:"That is just the water working!",s:"Keep letting it."},
  {e:'üåª',t:"Turning toward the light!",s:"Just like a sunflower, just like you."},
  {e:'ü´∂',t:"Water is on your side and so is your crew!",s:"Both are cheering."},
  {e:'üéÄ',t:"The prettiest habit anyone can have!",s:"Drinking water is your signature."},
  {e:'üíé',t:"Crystal clear and crystal hydrated!",s:"Sparkling inside and out."},
  {e:'üå∑',t:"In full bloom!",s:"Water is the reason."},
  {e:'üçã',t:"Zesty approach to health!",s:"Citrus coded and thriving."},
  {e:'üéâ',t:"Party in your cells right now!",s:"Water brought the music."},
  {e:'ü™∑',t:"Petals opening, energy flowing!",s:"You are growing beautifully."},
  {e:'ü´ô',t:"Bottled up greatness just released!",s:"That was the sip that did it."},
  {e:'üå¨Ô∏è',t:"Breezy and radiant!",s:"Hydration makes everything lighter."},
  {e:'ü©∞',t:"On pointe!",s:"Your wellness routine is elegance itself."},
  {e:'ü´ê',t:"Deep, rich, and nourished!",s:"Just like you."},
  {e:'üå∏',t:"Goals rising and energy soaring!",s:"Keep going, you are doing great."},
  {e:'üíï',t:"Full of love and full of water!",s:"The best combination possible."},
  {e:'ü™∏',t:"Thriving in your own ecosystem!",s:"Deep, colorful, and alive."},
  {e:'üßÅ',t:"Water is the gift that keeps giving!",s:"And you keep accepting it."},
  {e:'üåÖ',t:"Every sip is a sunrise moment!",s:"New energy, brand new you."},
  {e:'üçë',t:"Peachy keen and hydrated!",s:"Could not be more perfect."},
  {e:'üåü',t:"You are the moment!",s:"Hydrated, present, and glowing."},
  {e:'üé®',t:"A masterpiece in motion!",s:"Hydration is part of the canvas."},
  {e:'üíå',t:"Sending love to every single cell!",s:"They received it via water."},
  {e:'üå¥',t:"Swaying beautifully through your goals!",s:"Unbothered and hydrated."},
  {e:'üçµ',t:"Warm, nourishing, and intentional!",s:"That sip had real meaning."},
  {e:'üåä',t:"Every wave starts small!",s:"This sip is yours."},
  {e:'ü¶¢',t:"Floating through the day effortlessly!",s:"Water makes you weightless."},
  {e:'üé∂',t:"Hydration hits different when you are consistent!",s:"You know the melody now."},
  {e:'üå∫',t:"Rare dedication, rare results!",s:"Not everyone shows up like you do."},
  {e:'üíÖ',t:"Hydration? Served!",s:"On a silver platter, no less."},
  {e:'ü´ß',t:"Fizzing with good energy!",s:"You are practically sparkling."},
  {e:'üéÄ',t:"The habit that looks good on everyone!",s:"Drinking water is your move."},
  {e:'üåô',t:"Even the stars stay hydrated!",s:"You are in great company."},
  {e:'üíñ',t:"Overflowing with good energy and hydration!",s:"Both are contagious."},
  {e:'üåà',t:"Full spectrum of amazing!",s:"Water brings out every color in you."},
  {e:'ü™Ñ',t:"A little magic in every sip!",s:"You are the spell and the spellcaster."},
  {e:'üçã',t:"Squeezing the most out of every day!",s:"Starting with this sip."},
  {e:'üåª',t:"Bright, warm, and blooming!",s:"Water is your sunshine."},
  {e:'üíß',t:"Back to basics and absolutely winning!",s:"Water is the original glow up."},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let APP = null;
let CREW = [];

const plural = (n, w) => `${n} ${w}${n !== 1 ? 's' : ''}`;
const todayStr = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
const getLocalId = () => localStorage.getItem('hp_uid');
const setLocalId = id => localStorage.setItem('hp_uid', id);

function toRow(a) {
  return {
    id: a.id, name: a.name, points: a.points,
    total_drinks: a.totalDrinks, drinks: a.drinks,
    streak: a.streak, best_streak: a.bestStreak,
    daily_goal: a.dailyGoal,
    notif_times: a.notifTimes || ['09:00','14:00','19:00'],
    notifications_enabled: a.notificationsEnabled || false,
    friends: a.friends || [],
  };
}

function fromRow(r) {
  return {
    id: r.id, name: r.name, points: r.points || 0,
    totalDrinks: r.total_drinks || 0, drinks: r.drinks || {},
    streak: r.streak || 0, bestStreak: r.best_streak || 0,
    dailyGoal: r.daily_goal || 6,
    notifTimes: r.notif_times || ['09:00','14:00','19:00'],
    notificationsEnabled: r.notifications_enabled || false,
    friends: r.friends || [],
  };
}

async function save() { if (APP) await dbSave(toRow(APP)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT (called after splash dismissed)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function bootApp() {
  document.getElementById('loading-screen').style.display = 'flex';
  createBubbles();

  const params = new URLSearchParams(location.search);
  const invCode = params.get('invite');
  const uid = getLocalId();

  try {
    if (uid) {
      const row = await dbGet(uid);
      if (row) {
        APP = fromRow(row);
        if (invCode) await acceptInvite(invCode);
        hideLoading();
        enterApp();
        return;
      }
    }
    hideLoading();
    if (invCode) {
      const info = decodeInvite(invCode);
      if (info) {
        document.getElementById('join-inviter-name').textContent = info.name;
        document.getElementById('screen-join').dataset.code = invCode;
        showScreen('join');
        return;
      }
    }
    showScreen('setup');
  } catch(e) {
    console.error(e);
    hideLoading();
    showToast('Could not connect to server. Check your internet.');
    showScreen('setup');
  }
}

function hideLoading() {
  const el = document.getElementById('loading-screen');
  el.style.opacity = '0';
  setTimeout(() => el.style.display = 'none', 400);
}

function showScreen(n) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + n).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function encodeInvite(app) { return btoa(JSON.stringify({ id: app.id, name: app.name })); }
function decodeInvite(code) { try { return JSON.parse(atob(code)); } catch { return null; } }

async function acceptInvite(code) {
  const info = decodeInvite(code);
  if (!info || !APP || info.id === APP.id) return;
  let changed = false;
  if (!APP.friends.includes(info.id)) { APP.friends.push(info.id); changed = true; }
  const theirRow = await dbGet(info.id);
  if (theirRow) {
    const tf = theirRow.friends || [];
    if (!tf.includes(APP.id)) { tf.push(APP.id); await dbPatch(info.id, { friends: tf }); }
  }
  if (changed) { await save(); showToast(`${info.name} added to your crew!`); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP / JOIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function setupUser() {
  const name = document.getElementById('setup-name').value.trim();
  if (!name) { document.getElementById('setup-name').focus(); return; }
  const btn = document.getElementById('setup-btn');
  btn.disabled = true; btn.textContent = 'Creating...';
  const goal = parseInt(document.querySelector('#setup-goal-picker .goal-opt.active')?.dataset.val || '6');
  const id = self.crypto.randomUUID();
  APP = { id, name, points: 0, totalDrinks: 0, drinks: {}, streak: 0, bestStreak: 0, dailyGoal: goal, notifTimes: ['09:00','14:00','19:00'], notificationsEnabled: false, friends: [] };
  try {
    await save(); setLocalId(id); enterApp();
  } catch(e) {
    btn.disabled = false; btn.textContent = 'üíß Start Hydrating';
    showToast('Connection failed. Check internet and try again.');
  }
}

async function joinUser() {
  const name = document.getElementById('join-name').value.trim();
  if (!name) { document.getElementById('join-name').focus(); return; }
  const btn = document.getElementById('join-btn');
  btn.disabled = true; btn.textContent = 'Joining...';
  const goal = parseInt(document.querySelector('#join-goal-picker .goal-opt.active')?.dataset.val || '6');
  const code = document.getElementById('screen-join').dataset.code;
  const inviterInfo = decodeInvite(code);
  const id = self.crypto.randomUUID();
  APP = { id, name, points: 0, totalDrinks: 0, drinks: {}, streak: 0, bestStreak: 0, dailyGoal: goal, notifTimes: ['09:00','14:00','19:00'], notificationsEnabled: false, friends: inviterInfo ? [inviterInfo.id] : [] };
  try {
    await save(); setLocalId(id);
    if (inviterInfo) {
      const theirRow = await dbGet(inviterInfo.id);
      if (theirRow) {
        const tf = theirRow.friends || [];
        if (!tf.includes(id)) { tf.push(id); await dbPatch(inviterInfo.id, { friends: tf }); }
      }
    }
    enterApp(); showToast(`Welcome to the crew, ${name}!`);
  } catch(e) {
    btn.disabled = false; btn.textContent = 'üíß Join the Crew';
    showToast('Connection failed. Check internet and try again.');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function enterApp() {
  showScreen('main');
  document.getElementById('main-nav').style.display = 'flex';
  history.replaceState({}, '', location.pathname);
  refreshUI(); loadCrew(); initNotifUI(); scheduleNotifications();
  if (window._crewPoll) clearInterval(window._crewPoll);
  window._crewPoll = setInterval(loadCrew, 20000);
}

async function loadCrew() {
  if (!APP || !APP.friends.length) { CREW = []; renderCrew(); return; }
  try { const rows = await dbGetMany(APP.friends); CREW = rows || []; renderCrew(); } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshUI() {
  if (!APP) return;
  const t = todayStr();
  const count = APP.drinks[t] || 0;
  const goal = APP.dailyGoal || 6;
  const met = count >= goal;

  document.getElementById('display-name').textContent = APP.name;
  document.getElementById('display-points').textContent = APP.points;

  const ring = document.getElementById('progress-ring-fill');
  ring.style.strokeDashoffset = 527.8 - Math.min(count/goal,1) * 527.8;
  ring.classList.toggle('goal-done', met);

  document.getElementById('drink-btn').classList.toggle('goal-met', met);
  document.getElementById('drink-btn-icon').textContent = met ? '‚úÖ' : 'üíß';
  document.getElementById('drink-btn-label').textContent = met ? 'GOAL MET!' : 'LOG DRINK';
  document.getElementById('drink-status').textContent = `${count} / ${goal} glasses today`;
  document.getElementById('goal-hint').textContent = met ? 'Tap again to log more!' : `${goal - count} more to hit your goal!`;

  const sgv = document.getElementById('settings-goal-val');
  if (sgv) sgv.textContent = goal;
  const snd = document.getElementById('settings-name-display');
  if (snd) snd.textContent = APP.name;
  const suid = document.getElementById('settings-userid');
  if (suid) suid.textContent = `ID: ${APP.id.slice(0,8)}...`;
  document.querySelectorAll('#settings-goal-picker .goal-opt').forEach(b => b.classList.toggle('active', parseInt(b.dataset.val) === goal));

  renderMonth(); renderWeekChart(); renderStats(); renderInviteLink();
}

function renderMonth() {
  const now = new Date(); const t = todayStr(); const goal = APP.dailyGoal || 6;
  const grid = document.getElementById('month-grid');
  grid.innerHTML = '';
  ['S','M','T','W','T','F','S'].forEach(d => {
    const h = document.createElement('div'); h.className = 'month-day-header'; h.textContent = d; grid.appendChild(h);
  });
  const first = new Date(now.getFullYear(), now.getMonth(), 1);
  const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  for (let i = 0; i < first.getDay(); i++) grid.appendChild(document.createElement('div'));
  for (let d = 1; d <= days; d++) {
    const ds = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const c = APP.drinks[ds] || 0;
    const cell = document.createElement('div');
    cell.className = 'month-day' + (c>=goal?' filled':'') + (ds===t?' today':'') + (ds>t?' future':'');
    cell.textContent = d; cell.title = `${ds}: ${c} glass${c!==1?'es':''}`;
    grid.appendChild(cell);
  }
  const s = calcStreak();
  document.getElementById('streak-label').textContent = s > 0 ? `üî• ${plural(s,'day')}` : 'Start your streak!';
}

function calcStreak() {
  const now = new Date(); const goal = APP.dailyGoal || 6; let s = 0;
  for (let i = 0; i < 365; i++) {
    const d = new Date(now); d.setDate(d.getDate()-i);
    if ((APP.drinks[d.toISOString().slice(0,10)]||0) >= goal) s++;
    else break;
  }
  return s;
}

function renderWeekChart() {
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const now = new Date(); const t = todayStr();
  const chart = document.getElementById('week-chart'); chart.innerHTML = '';
  const last7 = [];
  for (let i=6;i>=0;i--) { const d=new Date(now); d.setDate(d.getDate()-i); last7.push(d.toISOString().slice(0,10)); }
  const goal = APP.dailyGoal || 6;
  const max = Math.max(goal, ...last7.map(d=>APP.drinks[d]||0));
  last7.forEach(ds => {
    const d = new Date(ds); const c = APP.drinks[ds]||0; const isT = ds===t;
    const wrap = document.createElement('div'); wrap.className='day-bar-wrap';
    const bar = document.createElement('div');
    bar.className='day-bar'+(c>0?(isT?' today-bar':' has-data'):'');
    bar.style.height=(c/max*70+(c>0?6:4))+'px';
    const label = document.createElement('div');
    label.className='day-label'+(isT?' today-label':'');
    label.textContent=days[d.getDay()].charAt(0);
    wrap.appendChild(bar); wrap.appendChild(label); chart.appendChild(wrap);
  });
}

function renderStats() {
  document.getElementById('stat-total-pts').textContent = APP.points;
  document.getElementById('stat-total-drinks').textContent = APP.totalDrinks||0;
  const cur = calcStreak();
  const best = Math.max(APP.bestStreak||0, cur);
  APP.bestStreak = best;
  document.getElementById('stat-best-streak').textContent = plural(best,'day');
  document.getElementById('stat-cur-streak').textContent = plural(cur,'day');
}

function renderCrew() {
  const list = document.getElementById('friends-list');
  const t = todayStr(); const goal = APP.dailyGoal || 6;
  const me = { name: APP.name+' (you)', points: APP.points, streak: calcStreak(), met: (APP.drinks[t]||0)>=goal, isMe: true };
  const others = CREW.map(f => ({ name: f.name, points: f.points||0, streak: f.streak||0, met: ((f.drinks||{})[t]||0)>=(f.daily_goal||6), isMe: false }));
  const all = [me, ...others].sort((a,b) => b.points - a.points);

  if (all.length <= 1) { list.innerHTML = '<div class="empty-friends">Invite a friend to compete! Share your link below.</div>'; return; }

  list.innerHTML = '';
  const medals = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü'];
  all.forEach((f, i) => {
    const row = document.createElement('div');
    row.className = 'friend-row';
    if (f.isMe) row.style.borderColor = 'rgba(56,182,255,0.35)';
    row.innerHTML = `
      <div class="friend-avatar">${medals[i]||'üíß'}</div>
      <div style="flex:1">
        <div class="friend-name">${f.name}</div>
        <div style="font-size:0.75rem;color:var(--foam);opacity:0.6">üî• ${plural(f.streak,'day')}</div>
      </div>
      <div style="text-align:right">
        <div class="friend-pts">‚≠ê ${f.points}</div>
        <div style="font-size:0.8rem;margin-top:2px">${f.met?'‚úÖ goal met':'‚è≥ pending'}</div>
      </div>`;
    list.appendChild(row);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG DRINK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function logDrink() {
  if (!APP) return;
  const t = todayStr(); const goal = APP.dailyGoal || 6;
  const prev = APP.drinks[t] || 0;
  APP.drinks[t] = prev + 1;
  APP.totalDrinks = (APP.totalDrinks||0) + 1;
  const newC = APP.drinks[t];
  const justMet = newC === goal;
  APP.points += justMet ? 2 : 1;
  const s = calcStreak(); APP.streak = s; APP.bestStreak = Math.max(APP.bestStreak||0, s);
  refreshUI();
  save().catch(() => showToast('Sync failed'));
  const aff = AFF[Math.floor(Math.random()*AFF.length)];
  showAff(aff, justMet ? 2 : 1, justMet, newC, goal);
  if (justMet || APP.points % 10 === 0) launchConfetti();
}

function showAff(aff, pts, justMet, count, goal) {
  const s = calcStreak();
  document.getElementById('aff-emoji').textContent = justMet ? 'üèÜ' : aff.e;
  document.getElementById('aff-points').textContent = `+${pts} point${pts!==1?'s':''}!`;
  document.getElementById('aff-text').textContent = justMet ? `GOAL SMASHED! ${count}/${goal} glasses!` : aff.t;
  document.getElementById('aff-sub').textContent = justMet
    ? `Streak: üî• ${plural(s,'day')} and going strong!`
    : aff.s;
  document.getElementById('affirmation-overlay').classList.add('show');
}

function closeAffirmation() { document.getElementById('affirmation-overlay').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectGoal(btn) {
  const picker = btn.closest('.goal-picker');
  picker.querySelectorAll('.goal-opt').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (picker.id === 'settings-goal-picker' && APP) { APP.dailyGoal = parseInt(btn.dataset.val); save(); refreshUI(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.style.display='none');
  document.getElementById('tab-'+name).style.display='block';
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  refreshUI();
  if (name==='friends') loadCrew();
  if (name==='settings') initNotifUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInviteLink() {
  if (!APP) return;
  const link = `${location.origin}${location.pathname}?invite=${encodeInvite(APP)}`;
  const el = document.getElementById('invite-link-display');
  if (el) { el.textContent = link; el.dataset.link = link; }
}

function copyInviteLink() {
  const link = document.getElementById('invite-link-display').dataset.link;
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

function shareInvite() {
  const link = document.getElementById('invite-link-display').dataset.link;
  if (navigator.share) navigator.share({ title:'Join HydroPals! üíß', text:`${APP.name} wants you to track water together!`, url: link });
  else copyInviteLink();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initNotifUI() {
  if (!APP) return;
  const toggle = document.getElementById('notif-toggle'); if (!toggle) return;
  toggle.checked = APP.notificationsEnabled || false;
  document.getElementById('notif-time-section').style.display = APP.notificationsEnabled ? 'block' : 'none';
  if (APP.notifTimes) {
    const [t1,t2,t3] = APP.notifTimes;
    if (t1) document.getElementById('notif-time-1').value = t1;
    if (t2) document.getElementById('notif-time-2').value = t2;
    if (t3) document.getElementById('notif-time-3').value = t3;
  }
  if ('Notification' in window && Notification.permission==='denied') {
    const s = document.getElementById('notif-status');
    s.style.display='block'; s.style.color='var(--coral)';
    s.textContent='Notifications blocked. Click the lock icon in your address bar to allow.';
    toggle.checked=false;
  }
}

async function toggleNotifications(cb) {
  const st = document.getElementById('notif-status');
  const ts = document.getElementById('notif-time-section');
  if (!('Notification' in window)) {
    st.style.display='block'; st.style.color='var(--coral)'; st.textContent='This browser does not support notifications.'; cb.checked=false; return;
  }
  if (cb.checked) {
    let p = Notification.permission;
    if (p==='default') p = await Notification.requestPermission();
    if (p==='granted') {
      APP.notificationsEnabled=true; ts.style.display='block';
      st.style.display='block'; st.style.color='var(--mint)'; st.textContent='Reminders are on!';
      new Notification('üíß HydroPals', { body: `Hey ${APP.name}! Your reminders are now active.` });
      saveNotifTimes();
    } else {
      cb.checked=false; APP.notificationsEnabled=false; ts.style.display='none';
      st.style.display='block'; st.style.color='var(--coral)'; st.textContent='Blocked. Go to browser site settings and allow notifications.';
    }
  } else {
    APP.notificationsEnabled=false; ts.style.display='none'; st.style.display='none';
  }
  save();
}

function saveNotifTimes() {
  if (!APP) return;
  APP.notifTimes = [
    document.getElementById('notif-time-1').value,
    document.getElementById('notif-time-2').value,
    document.getElementById('notif-time-3').value,
  ];
  save(); scheduleNotifications();
}

function scheduleNotifications() {
  if (!APP||!APP.notificationsEnabled||!('Notification' in window)||Notification.permission!=='granted') return;
  const times = APP.notifTimes||['09:00','14:00','19:00'];
  if (window._nTimers) window._nTimers.forEach(t=>clearTimeout(t));
  window._nTimers=[];
  const msgs=[
    {title:'üíß Morning reminder!',body:`Good morning ${APP.name}! Start your day with water.`},
    {title:'üíß Afternoon reminder!',body:`Hey ${APP.name}! Time for a midday sip.`},
    {title:'üíß Evening reminder!',body:`Almost done ${APP.name}! Log your evening drink.`},
  ];
  times.forEach((ts,i)=>{
    if(!ts) return;
    const [h,m]=ts.split(':').map(Number);
    const target=new Date(); target.setHours(h,m,0,0);
    if(target<=new Date()) target.setDate(target.getDate()+1);
    const timer=setTimeout(()=>{
      const c=APP?(APP.drinks[todayStr()]||0):0;
      const g=APP?(APP.dailyGoal||6):6;
      if(c<g) try{ new Notification(msgs[i].title,{body:msgs[i].body+` (${c}/${g} so far)`}); }catch(e){}
      scheduleNotifications();
    }, target-new Date());
    window._nTimers.push(timer);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.opacity='1';
  clearTimeout(window._tt);
  window._tt=setTimeout(()=>t.style.opacity='0',3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFETTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launchConfetti() {
  const canvas=document.getElementById('confetti-canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  const pieces=Array.from({length:80},()=>({
    x:Math.random()*canvas.width,y:-10,r:Math.random()*6+4,
    color:['#38b6ff','#00e5c3','#ffe066','#a8e6ff','#ff6b6b','#7fffea','#ffb3d9'][Math.floor(Math.random()*7)],
    tilt:Math.random()*10-5,tiltAngle:0,tiltSpeed:Math.random()*0.1+0.05,
    vy:Math.random()*3+2,vx:Math.random()*2-1,
  }));
  let frame=0;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r,p.r*0.6,p.tilt,0,Math.PI*2);
      ctx.fillStyle=p.color; ctx.fill();
      p.y+=p.vy; p.x+=p.vx; p.tiltAngle+=p.tiltSpeed; p.tilt=Math.sin(p.tiltAngle)*12;
    });
    frame++;
    if(frame<120) requestAnimationFrame(draw);
    else ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  draw();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUBBLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createBubbles(){
  const c=document.getElementById('bubbles');
  for(let i=0;i<12;i++){
    const b=document.createElement('div'); b.className='bubble';
    const s=Math.random()*40+10;
    b.style.cssText=`width:${s}px;height:${s}px;left:${Math.random()*100}%;animation-duration:${Math.random()*15+10}s;animation-delay:${Math.random()*10}s;`;
    c.appendChild(b);
  }
}

// Kick off bubbles immediately so they show on splash too
createBubbles();
</script>
</body>
</html>
